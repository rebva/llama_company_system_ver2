<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Abyssal Nexus Console</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&family=Rajdhani:wght@300;500;700&family=Zen+Kaku+Gothic+New:wght@300;500;700&display=swap"
      rel="stylesheet"
    />

    <style>
      :root {
        /* Theme: Deep Sea Future */
        --bg-deep: #02060c; /* Ê∑±Êµ∑Ëâ≤ */
        --glass-bg: rgba(10, 25, 40, 0.55); /* Â∞ë„ÅóÈùí„Åø„ÅÆ„ÅÇ„Çã„Ç¨„É©„Çπ */
        --glass-border: rgba(100, 200, 255, 0.15); /* Ê∞¥Ëâ≤„ÅÆÂ¢ÉÁïåÁ∑ö */
        --primary: #00ffea; /* Bioluminescent Aqua */
        --secondary: #0066ff; /* Ocean Blue */
        --accent: #ff3366; /* Warning Red (unchanged) */

        --text-main: #e0f7ff;
        --text-muted: #7a9ab8;

        /* Effects */
        --blur: blur(20px);
        --ease: cubic-bezier(0.23, 1, 0.32, 1);
      }

      * {
        box-sizing: border-box;
      }

      body {
        margin: 0;
        font-family: "Rajdhani", "Zen Kaku Gothic New", sans-serif;
        background-color: var(--bg-deep);
        /* Ê∑±Êµ∑„ÅÆ„Ç∞„É©„Éá„Éº„Ç∑„Éß„É≥ËÉåÊôØ */
        background-image: radial-gradient(
          circle at 50% 0%,
          #091f3a 0%,
          var(--bg-deep) 60%
        );
        color: var(--text-main);
        min-height: 100vh;
        display: flex;
        justify-content: center;
        padding: 40px 20px;
        overflow-x: hidden;
        position: relative;
      }

      /* --- Deep Sea Bubbles Animation --- */
      .bubbles-container {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        z-index: -1;
        pointer-events: none;
      }

      .bubble-bg {
        position: absolute;
        bottom: -100px;
        background: radial-gradient(
          circle at 30% 30%,
          rgba(255, 255, 255, 0.2),
          rgba(0, 255, 234, 0.1) 60%
        );
        border-radius: 50%;
        box-shadow: inset 0 0 10px rgba(0, 255, 234, 0.3);
        animation: rise var(--rise-time) var(--rise-ease) infinite;
        opacity: 0.6;
      }

      @keyframes rise {
        0% {
          transform: translateY(0) translateX(0) scale(1);
          opacity: 0;
        }
        10% {
          opacity: var(--bubble-opacity);
        }
        50% {
          transform: translateY(calc(var(--rise-height) * -0.5))
            translateX(var(--sway-amount));
        }
        100% {
          transform: translateY(calc(var(--rise-height) * -1))
            translateX(calc(var(--sway-amount) * -1)) scale(1.2);
          opacity: 0;
        }
      }

      /* Ambient light sources */
      body::before,
      body::after {
        content: "";
        position: fixed;
        width: 60vw;
        height: 60vw;
        border-radius: 50%;
        filter: blur(120px);
        z-index: -2;
        opacity: 0.3;
        animation: pulseLight 15s infinite alternate ease-in-out;
      }
      body::before {
        background: radial-gradient(circle, var(--secondary), transparent 60%);
        bottom: -20%;
        left: -20%;
      }
      body::after {
        background: radial-gradient(circle, var(--primary), transparent 60%);
        top: -20%;
        right: -20%;
        animation-delay: -7s;
      }
      @keyframes pulseLight {
        0% {
          opacity: 0.2;
          transform: scale(1);
        }
        100% {
          opacity: 0.4;
          transform: scale(1.1);
        }
      }

      /* Scrollbar styling */
      ::-webkit-scrollbar {
        width: 6px;
      }
      ::-webkit-scrollbar-track {
        background: rgba(0, 0, 0, 0.2);
      }
      ::-webkit-scrollbar-thumb {
        background: rgba(0, 255, 234, 0.3);
        border-radius: 3px;
      }

      /* Main Shell */
      .shell {
        width: min(1400px, 100%);
        background: var(--glass-bg);
        border: 1px solid var(--glass-border);
        border-top: 1px solid rgba(0, 255, 234, 0.3); /* Top highlight */
        border-radius: 24px;
        box-shadow: 0 30px 60px rgba(0, 0, 0, 0.6),
          inset 0 0 20px rgba(0, 255, 234, 0.05);
        backdrop-filter: var(--blur);
        -webkit-backdrop-filter: var(--blur);
        overflow: hidden;
        display: flex;
        flex-direction: column;
        position: relative;
      }

      /* Subtle water caustics overlay effect */
      .shell::after {
        content: "";
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: url("data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIyMDAiIGhlaWdodD0iMjAwIj48ZmlsdGVyIGlkPSJhIj48ZmUVdXJidWxlbmNlIGJhc2VGcmVxdWVuY3k9Ii4wMDUiIG51bW9jdGF2ZXM9IjIiIHJlc3VsdD0iYiIvPjxmZURpc3BsYWNlbWVudE1hcCBpbj0iU291cmNlR3JhcGhpYyIgaW4yPSJiIiBzY2FsZT0iMjAiLz48L2ZpbHRlcj48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWx0ZXI9InVybCgjYSkiIG9wYWNpdHk9IjAuMDMiLz48L3N2Zz4=");
        opacity: 0.15;
        mix-blend-mode: overlay;
        pointer-events: none;
        z-index: 1;
      }
      .shell > * {
        position: relative;
        z-index: 2;
      } /* Ensure content is above caustics */

      header {
        padding: 20px 30px;
        border-bottom: 1px solid var(--glass-border);
        display: flex;
        align-items: center;
        justify-content: space-between;
        background: rgba(0, 10, 20, 0.3);
      }

      header h1 {
        margin: 0;
        font-family: "Orbitron", sans-serif;
        font-size: 24px;
        font-weight: 700;
        letter-spacing: 3px;
        /* Bioluminescent text effect */
        color: var(--primary);
        text-shadow: 0 0 15px rgba(0, 255, 234, 0.6);
      }

      .badge {
        padding: 6px 16px;
        border: 1px solid var(--glass-border);
        border-radius: 20px;
        font-size: 11px;
        font-weight: 600;
        letter-spacing: 1px;
        text-transform: uppercase;
        background: rgba(0, 0, 0, 0.4);
        color: var(--text-muted);
        box-shadow: inset 0 0 10px rgba(0, 0, 0, 0.5);
        transition: 0.3s;
      }

      .grid {
        display: grid;
        grid-template-columns: 380px 1fr;
        grid-template-rows: auto 1fr;
        gap: 24px;
        padding: 30px;

        /* üîΩ Âõ∫ÂÆö„Å´Ëøë„ÅÑÈ´ò„Åï„Çí„ÇÑ„ÇÅ„Çã */
        height: auto;
        min-height: 0;
      }

      @media (max-width: 1024px) {
        .grid {
          grid-template-columns: 1fr;
          height: auto;
        }
        body {
          padding: 10px;
        }
      }

      .card {
        background: rgba(
          20,
          40,
          60,
          0.15
        ); /* Slightly more opaque for deep sea feel */
        border: 1px solid var(--glass-border);
        border-radius: 16px;
        padding: 20px;
        display: flex;
        flex-direction: column;
        transition: all 0.3s var(--ease);
        position: relative;
        overflow: hidden;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
      }

      .card:hover {
        border-color: rgba(0, 255, 234, 0.3);
        background: rgba(20, 40, 60, 0.25);
        box-shadow: 0 0 30px rgba(0, 255, 234, 0.1);
      }

      /* Specific Card Layouts */
      .card:nth-child(1) {
        grid-row: 1;
      }
      .card:nth-child(2) {
        grid-column: 2;
        grid-row: 1 / span 3;
      }
      .card:nth-child(3) {
        grid-row: 2;
      }
      .card:nth-child(4) {
        display: none;
      }
      .card:nth-child(5) {
        grid-row: 3;
      }

      .card h2 {
        margin: 0 0 16px;
        font-family: "Orbitron", sans-serif;
        font-size: 14px;
        letter-spacing: 1.5px;
        color: var(--primary);
        text-transform: uppercase;
        display: flex;
        align-items: center;
        gap: 8px;
        text-shadow: 0 0 8px rgba(0, 255, 234, 0.4);
      }

      label {
        display: block;
        font-size: 11px;
        font-weight: 500;
        color: var(--text-muted);
        margin-bottom: 8px;
        letter-spacing: 0.5px;
        text-transform: uppercase;
      }

      input,
      select,
      textarea {
        width: 100%;
        border: 1px solid var(--glass-border);
        border-radius: 8px;
        background: rgba(0, 15, 30, 0.6);
        color: var(--text-main);
        padding: 12px 16px;
        font-family: "Rajdhani", sans-serif;
        font-size: 15px;
        outline: none;
        transition: 0.3s var(--ease);
      }
      input:focus,
      textarea:focus {
        border-color: var(--primary);
        box-shadow: 0 0 15px rgba(0, 255, 234, 0.2);
        background: rgba(0, 20, 40, 0.7);
      }
      textarea {
        resize: none;
        min-height: 80px;
        line-height: 1.6;
      }

      button {
        background: rgba(0, 255, 234, 0.1);
        border: 1px solid var(--primary);
        color: var(--primary);
        font-family: "Orbitron", sans-serif;
        font-weight: 700;
        font-size: 12px;
        padding: 12px 20px;
        border-radius: 8px;
        cursor: pointer;
        width: 100%;
        transition: all 0.3s var(--ease);
        text-transform: uppercase;
        letter-spacing: 1px;
        position: relative;
        overflow: hidden;
        text-shadow: 0 0 5px rgba(0, 255, 234, 0.4);
      }
      button:hover {
        background: var(--primary);
        color: #002233;
        box-shadow: 0 0 25px var(--primary);
        transform: translateY(-2px);
      }
      button.secondary {
        background: transparent;
        border-color: var(--glass-border);
        color: var(--text-muted);
        text-shadow: none;
      }
      button.secondary:hover {
        border-color: var(--text-main);
        color: var(--text-main);
        background: rgba(255, 255, 255, 0.05);
        box-shadow: none;
      }

      .row {
        display: flex;
        gap: 12px;
        margin-bottom: 12px;
      }
      .row > * {
        flex: 1;
      }

      .status {
        margin-top: 10px;
        font-size: 12px;
        min-height: 20px;
        color: var(--text-muted);
        transition: 0.3s;
      }
      .status.error {
        color: var(--accent);
        text-shadow: 0 0 10px rgba(255, 51, 102, 0.4);
      }
      .status.ok {
        color: #00ff9d;
        text-shadow: 0 0 10px rgba(0, 255, 157, 0.4);
      }

      .pill-toggle {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 4px;
        background: rgba(0, 10, 25, 0.5);
        border-radius: 10px;
        padding: 4px;
        margin-bottom: 20px;
        border: 1px solid var(--glass-border);
      }
      .pill-toggle button {
        background: transparent;
        border: none;
        color: var(--text-muted);
        font-family: "Rajdhani", sans-serif;
        font-size: 14px;
        padding: 8px;
        border-radius: 6px;
        text-shadow: none;
        box-shadow: none;
      }
      .pill-toggle button.active {
        background: rgba(0, 255, 234, 0.15);
        color: var(--primary);
        border: 1px solid var(--primary);
        box-shadow: 0 0 10px rgba(0, 255, 234, 0.2);
        text-shadow: 0 0 5px rgba(0, 255, 234, 0.5);
      }
      .pill-toggle button:hover {
        transform: none;
      }

      .messages {
        flex: 1;
        display: flex;
        flex-direction: column;
        gap: 16px;
        overflow-y: auto;
        padding: 10px 4px;
        margin-bottom: 20px;
        border-top: 1px solid var(--glass-border);
        border-bottom: 1px solid var(--glass-border);
        background: rgba(0, 10, 25, 0.3);
        border-radius: 8px;
        scroll-behavior: smooth;
      }

      .bubble {
        max-width: 85%;
        padding: 16px;
        border-radius: 12px;
        line-height: 1.6;
        font-size: 15px;
        position: relative;
        animation: slideIn 0.3s var(--ease);
        backdrop-filter: blur(5px);
      }
      @keyframes slideIn {
        from {
          opacity: 0;
          transform: translateY(15px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      .bubble.user {
        align-self: flex-end;
        background: rgba(0, 255, 234, 0.07);
        border: 1px solid rgba(0, 255, 234, 0.3);
        color: var(--primary);
        border-bottom-right-radius: 2px;
      }

      .bubble.assistant {
        align-self: flex-start;
        background: rgba(255, 255, 255, 0.04);
        border: 1px solid var(--glass-border);
        color: var(--text-main);
        border-bottom-left-radius: 2px;
      }

      .bubble div:first-child {
        font-size: 10px;
        letter-spacing: 1px;
        margin-bottom: 6px;
        opacity: 0.7;
        font-family: "Orbitron", sans-serif;
      }

      .sources {
        margin-top: 10px;
        padding-top: 10px;
        border-top: 1px dashed var(--glass-border);
        font-size: 12px;
        color: var(--text-muted);
        font-family: monospace;
      }

      .list {
        background: rgba(0, 10, 25, 0.4);
        border: 1px solid var(--glass-border);
        border-radius: 8px;
        padding: 0;
        max-height: 200px;
        overflow-y: auto;
      }
      .list-item {
        padding: 12px;
        border-bottom: 1px solid var(--glass-border);
        font-size: 13px;
        transition: 0.2s;
        cursor: default;
      }
      .list-item:hover {
        background: rgba(0, 255, 234, 0.05);
      }
      .list-item:last-child {
        border-bottom: none;
      }
      .list-item strong {
        color: var(--primary);
      }

      @media (max-width: 768px) {
        .shell {
          border-radius: 0;
          border: none;
          background: transparent;
          box-shadow: none;
        }
        .shell::after {
          display: none;
        }
      }
    </style>
  </head>
  <body>
    <div class="bubbles-container" id="bubbles-container"></div>

    <div class="shell">
      <header>
        <h1>
          ABYSSAL NEXUS
          <span style="font-size: 0.5em; opacity: 0.6; font-weight: 300"
            >// DEEP DIVE v3.0</span
          >
        </h1>
        <span class="badge" id="auth-badge">UNAUTHORIZED</span>
      </header>

      <div class="grid">
        <div class="card">
          <h2>01 // BIOMETRIC AUTH</h2>
          <label>API Uplink</label>
          <input id="base-url" value="http://sawachi2:8080" />
          <div class="row" style="margin-top: 12px">
            <div>
              <label>Operative ID</label>
              <input id="username" value="admin" placeholder="admin" />
            </div>
            <div>
              <label>Security Code</label>
              <input
                id="password"
                type="password"
                value="password123"
                placeholder="password123"
              />
            </div>
          </div>
          <div class="row" style="margin-top: 16px">
            <button onclick="login()">ESTABLISH LINK</button>
            <button class="secondary" onclick="registerUser()">
              NEW OPERATIVE
            </button>
          </div>
          <div class="status" id="auth-status"></div>
        </div>

        <div class="card" style="display: flex; flex-direction: column">
          <div
            style="
              display: flex;
              justify-content: space-between;
              align-items: center;
              margin-bottom: 10px;
            "
          >
            <h2>02 // NEURAL INTERFACE</h2>
            <div
              style="
                font-size: 10px;
                color: var(--primary);
                font-family: monospace;
                opacity: 0.7;
              "
            >
              SYS.ONLINE // DEPTH: 8,000M
            </div>
          </div>

          <div class="pill-toggle">
            <button id="tab-chat" class="active" onclick="setMode('chat')">
              DIRECT COMMS
            </button>
            <button id="tab-rag" onclick="setMode('rag')">
              KNOWLEDGE BASE
            </button>
          </div>

          <div class="row">
            <div style="flex: 1">
              <label>Session ID</label>
              <input
                id="session-id"
                placeholder="demo-session"
                style="font-family: monospace"
              />
            </div>
            <div style="flex: 2">
              <label>Quantum Token</label>
              <input
                id="token"
                placeholder="Awaiting authentication..."
                readonly
                style="color: var(--text-muted)"
              />
            </div>
          </div>

          <div class="messages" id="messages">
            <div
              style="
                text-align: center;
                padding: 40px;
                color: var(--glass-border);
                font-size: 12px;
                letter-spacing: 1px;
              "
            >
              AWAITING INPUT SIGNAL...
            </div>
          </div>

          <div style="margin-top: auto">
            <label
              id="prompt-label"
              style="display: flex; justify-content: space-between"
            >
              <span>Command Directive</span>
              <span style="opacity: 0.5; font-size: 9px">MD SUPPORTED</span>
            </label>
            <div style="position: relative">
              <textarea
                id="message"
                placeholder="Enter directive or target data stream URL..."
              ></textarea>
              <div
                style="
                  position: absolute;
                  bottom: 12px;
                  right: 12px;
                  width: 110px;
                "
              >
                <button
                  onclick="sendMessage()"
                  style="padding: 8px; font-size: 11px"
                >
                  TRANSMIT
                </button>
              </div>
            </div>
            <div
              class="status"
              id="chat-status"
              style="margin-top: 4px; text-align: right"
            ></div>
          </div>
        </div>

        <div class="card">
          <h2>03 // DATA ARCHIVES</h2>
          <label>Search Query</label>
          <input id="history-q" placeholder="Keywords..." />
          <div class="row" style="margin-top: 10px">
            <input id="history-session" placeholder="Target Session ID" />
            <button onclick="searchHistory()" style="width: 80px">SCAN</button>
          </div>
          <div class="list" id="history-list" style="margin-top: 12px"></div>
        </div>

        <div class="card"></div>

        <div class="card">
          <h2>04 // CREW MANIFEST</h2>
          <button
            class="secondary"
            onclick="loadUsers()"
            style="margin-bottom: 12px"
          >
            UPDATE MANIFEST
          </button>
          <div class="list" id="users-list"></div>
        </div>
      </div>
    </div>

    <script>
      // --- Bubble Generation Script ---
      function createBubbles() {
        const container = document.getElementById("bubbles-container");
        const bubbleCount = 30; // Ê≥°„ÅÆÊï∞

        for (let i = 0; i < bubbleCount; i++) {
          const bubble = document.createElement("div");
          bubble.className = "bubble-bg";

          // „É©„É≥„ÉÄ„É†„Å™„Éë„É©„É°„Éº„Çø„ÇíÁîüÊàê
          const size = Math.random() * 60 + 10; // 10px ~ 70px
          const left = Math.random() * 100; // 0% ~ 100%
          const duration = Math.random() * 10 + 15; // 15s ~ 25s („ÇÜ„Å£„Åè„Çä)
          const delay = Math.random() * -20; // ÈñãÂßãÊôÇÈñì„Çí„Åö„Çâ„Åô
          const opacity = Math.random() * 0.4 + 0.1; // ÈÄèÊòéÂ∫¶
          const sway = (Math.random() - 0.5) * 100; // Â∑¶Âè≥„ÅÆÊè∫„ÇåÂπÖ
          const height = window.innerHeight + 200; // ‰∏äÊòá„Åô„ÇãÈ´ò„Åï

          // CSS„Ç´„Çπ„Çø„É†„Éó„É≠„Éë„ÉÜ„Ç£„Å´„Çª„ÉÉ„Éà
          bubble.style.width = `${size}px`;
          bubble.style.height = `${size}px`;
          bubble.style.left = `${left}%`;
          bubble.style.setProperty("--rise-time", `${duration}s`);
          bubble.style.setProperty("--bubble-opacity", opacity);
          bubble.style.setProperty("--sway-amount", `${sway}px`);
          bubble.style.setProperty("--rise-height", `${height}px`);
          bubble.style.setProperty(
            "--rise-ease",
            Math.random() > 0.5 ? "ease-in-out" : "linear"
          );
          bubble.style.animationDelay = `${delay}s`;

          container.appendChild(bubble);
        }
      }
      // Initialize bubbles on load
      createBubbles();

      // --- Existing App Logic ---
      let mode = "chat";
      const el = (id) => document.getElementById(id);

      function setStatus(id, msg, ok = false, err = false) {
        const box = el(id);
        box.textContent = msg || "";
        box.classList.remove("ok", "error");
        if (ok) box.classList.add("ok");
        if (err) box.classList.add("error");
      }

      function setMode(next) {
        mode = next;
        el("tab-chat").classList.toggle("active", mode === "chat");
        el("tab-rag").classList.toggle("active", mode === "rag");
        el("prompt-label").querySelector("span").textContent =
          mode === "chat"
            ? "Command Directive (URL Summary or Chat)"
            : "RAG Query (Vector Database Search)";
      }

      function saveToken(token) {
        el("token").value = token || "";
        const badge = el("auth-badge");
        if (token) {
          badge.textContent = "AUTHORIZED";
          badge.style.borderColor = "var(--primary)";
          badge.style.color = "var(--primary)";
          badge.style.boxShadow = "0 0 15px rgba(0,255,234,0.4)";
          badge.style.background = "rgba(0,255,234,0.1)";
        } else {
          badge.textContent = "UNAUTHORIZED";
          badge.style.borderColor = "var(--glass-border)";
          badge.style.color = "var(--text-muted)";
          badge.style.boxShadow = "none";
          badge.style.background = "rgba(0,0,0,0.4)";
        }
      }

      async function api(path, options = {}) {
        const baseInput = el("base-url").value.trim();
        const base = (baseInput || window.location.origin).replace(/\/$/, "");

        const token = el("token").value.trim();
        const headers = {
          "Content-Type": "application/json",
          ...(options.headers || {}),
        };
        if (token) headers["Authorization"] = "Bearer " + token;
        const resp = await fetch(base + path, { ...options, headers });
        if (!resp.ok) {
          const text = await resp.text();
          throw new Error(`${resp.status}: ${text}`);
        }
        const ct = resp.headers.get("content-type") || "";
        if (ct.includes("application/json")) return resp.json();
        return resp.text();
      }

      async function login() {
        setStatus("auth-status", "Initiating Handshake...");
        try {
          const data = await api("/login", {
            method: "POST",
            body: JSON.stringify({
              username: el("username").value,
              password: el("password").value,
            }),
          });
          saveToken(data.access_token);
          setStatus("auth-status", "Uplink Established", true);
        } catch (e) {
          setStatus("auth-status", e.message, false, true);
        }
      }

      async function registerUser() {
        setStatus("auth-status", "Processing New ID...");
        try {
          await api("/register", {
            method: "POST",
            body: JSON.stringify({
              username: el("username").value,
              password: el("password").value,
            }),
          });
          setStatus("auth-status", "ID Created. Awaiting Initial Login.", true);
        } catch (e) {
          setStatus("auth-status", e.message, false, true);
        }
      }

      function appendMessage(role, content, sources = []) {
        const wrap = document.createElement("div");
        wrap.className = "bubble " + role;

        const header = document.createElement("div");
        header.textContent =
          role === "user" ? "SOURCE // OPERATIVE" : "SOURCE // NEXUS AI";
        wrap.appendChild(header);

        const body = document.createElement("div");
        body.textContent = content;
        wrap.appendChild(body);

        if (sources.length) {
          const src = document.createElement("div");
          src.className = "sources";
          src.textContent =
            ">> DATA STREAMS: " +
            sources.map((s) => `${s.source}`).join(" // ");
          wrap.appendChild(src);
        }

        const container = el("messages");
        if (container.innerText.includes("AWAITING INPUT SIGNAL")) {
          container.innerHTML = "";
        }
        if (container.firstChild) {
          container.insertBefore(wrap, container.firstChild);
        } else {
          container.appendChild(wrap);
        }
        container.scrollTop = 0;
      }

      async function sendMessage() {
        const message = el("message").value.trim();
        if (!message) return;
        const sessionId = el("session-id").value.trim() || "demo";
        const path = mode === "chat" ? "/chat" : "/rag/chat";
        const payload =
          mode === "chat"
            ? { message, session_id: sessionId }
            : { question: message, session_id: sessionId };

        setStatus("chat-status", "Transmitting Data...");
        appendMessage("user", message);
        el("message").value = "";

        try {
          const data = await api(path, {
            method: "POST",
            body: JSON.stringify(payload),
          });
          if (mode === "chat") {
            appendMessage("assistant", data.reply || "");
            setStatus("chat-status", "Ack.", true);
          } else {
            appendMessage("assistant", data.answer || "", data.sources || []);
            setStatus("chat-status", "Ack (RAG).", true);
          }
        } catch (e) {
          setStatus("chat-status", e.message, false, true);
        }
      }

      async function searchHistory() {
        const q = el("history-q").value.trim();
        if (!q) return;
        const params = new URLSearchParams({ q });
        const sessionId = el("history-session").value.trim();
        if (sessionId) params.append("session_id", sessionId);
        setStatus("chat-status", "Scanning Archives...");
        try {
          const data = await api("/history/search?" + params.toString());
          const list = el("history-list");
          list.innerHTML = "";
          if (data.length === 0) {
            list.innerHTML =
              "<div style='padding:10px; color:var(--text-muted)'>No matching records.</div>";
          }
          data.forEach((item) => {
            const div = document.createElement("div");
            div.className = "list-item";
            div.innerHTML = `<strong>${item.role.toUpperCase()}</strong> <span style='opacity:0.5; font-size:11px;'>[ID:${
              item.session_id
            }]</span><br>${item.content.substring(0, 60)}...`;
            list.appendChild(div);
          });
          setStatus("chat-status", "Scan Complete", true);
        } catch (e) {
          setStatus("chat-status", e.message, false, true);
        }
      }

      async function loadUsers() {
        try {
          const data = await api("/admin/users");
          const list = el("users-list");
          list.innerHTML = "";
          data.forEach((u) => {
            const div = document.createElement("div");
            div.className = "list-item";
            div.innerHTML = `<span style='color:var(--primary)'>OP:${u.id}</span> ${u.username} <span style='font-size:10px; border:1px solid var(--glass-border); padding:1px 4px; border-radius:4px;'>${u.role}</span>`;
            list.appendChild(div);
          });
          setStatus("chat-status", "Manifest Updated", true);
        } catch (e) {
          setStatus("chat-status", e.message, false, true);
        }
      }

      el("message").addEventListener("keydown", (e) => {
        if (e.key === "Enter" && !e.shiftKey) {
          e.preventDefault();
          sendMessage();
        }
      });
    </script>
  </body>
</html>
